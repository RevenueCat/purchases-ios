## RevenueCat V4 API updates
There were various updates to our API when we migrated the ObjC pieces to Swift. Most were unavoidable, 
but a number of updates make our Swift API more idomatic. We'll be updating this list as we continue to release betas.

To start us off, Our framework name changed from `Purchases` to `RevenueCat` ðŸ˜»! We also updated all references of `Purchaser` to `Customer` to be more consistent across our platform. 

If you're using `Carthage`, make sure to use the new `RevenueCat.framework` or `RevenueCat.xcframework` instead of the old `Purchases`.

### Xcode version requirements and updated deployment targets
`purchases-ios` v4 requires using Xcode 13.2 or newer. 
It also updates the minimum deployment targets for iOS, macOS and tvOS. 

##### Minimum deployment targets
|  | v3 | v4 |
| :-: | :-: | :-: |
| iOS | 9.0 | 11.0 |
| tvOS | 9.0 | 11.0 |
| macOS | 10.12 | 10.13 |
| watchOS | 6.2 | 6.2 (unchanged) |

### Known Issues

#### ObjC + SPM
If you expose any Purchases objects from one target to another (see [example project](https://github.com/taquitos/SPMBug)
for what this could look like), that second target will not build due to a missing autogenerated header.
Currently there is a known bug in SPM whereby Xcode either doesn't pass the RevenueCat ObjC generated interface to SPM,
or SPM just doesn't integrate it. You can follow along: [SR-15154](https://bugs.swift.org/browse/SR-15154). 

##### Workaround: 
You must manually add the autogenerated file we committed to the repository
[RevenueCat-Swift.h](https://github.com/RevenueCat/purchases-ios/blob/main/IntegrationTests/CommonFiles/RevenueCat-Swift.h)
to your project, and `#import RevenueCat-Swift.h` in your bridging header. You can see how we do this in our
[SPMIntegration project](https://github.com/RevenueCat/purchases-ios/tree/main/IntegrationTests/SPMIntegration).

### ObjC type changes

`@import Purchases` is now `@import RevenueCat`

<table>
	<thead>
		<tr>
			<th>Old API</th>
			<th>New API</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>RCPurchaserInfo</td>
			<td>RCCustomerInfo</td>
		</tr>
		<tr>
			<td>(RCPurchasesErrorCode).RCOperationAlreadyInProgressError</td>
			<td>RCOperationAlreadyInProgressForProductError</td>
		</tr>
		<tr>
			<td>RCPurchasesErrorDomain</td>
			<td>RCPurchasesErrorCodeDomain</td>
		</tr>
		<tr>
			<td>RCBackendError</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCErrorUtils</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCBackendErrorDomain</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCFinishableKey</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCReceivePurchaserInfoBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCReceiveIntroEligibilityBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCReceiveOfferingsBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCReceiveProductsBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCPurchaseCompletedBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCDeferredPromotionalPurchaseBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCPaymentDiscountBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
				<tr>
			<td colspan="2" style="text-align:center;" ><strong>PurchasesDelegate<strong></td>
		</tr>
		<tr>
			<td>purchases:didReceiveUpdatedPurchaserInfo:</td>
			<td>purchases:didReceiveUpdatedCustomerInfo:</td>
		</tr>
	</tbody>
</table>

### ObjC API changes

<table>
	<thead>
		<tr>
			<th>Old API</th>
			<th>New API</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>purchaserInfoWithCompletion:</td>
			<td>getCustomerInfoWithCompletion:</td>
		</tr>
		<tr>
			<td>invalidatePurchaserInfoCache</td>
			<td>invalidateCustomerInfoCache</td>
		</tr>
		<tr>
			<td>Purchases -offeringsWithCompletion:</td>
			<td>Purchases -getOfferingsWithCompletion:</td>
		</tr>
		<tr>
			<td>Purchases -productsWithIdentifiers:completion:</td>
			<td>Purchases -getProductsWithIdentifiers:completion:</td>
		</tr>
		<tr>
			<td>Purchases -createAlias:</td>
			<td>Purchases -logIn:</td>
		</tr>
		<tr>
			<td>Purchases -identify:</td>
			<td>Purchases -logIn:</td>
		</tr>
		<tr>
			<td>Purchases -reset:</td>
			<td>Purchases -logOut:</td>
		</tr>
	</tbody>
</table>

### Swift type changes

`import Purchases` is now `import RevenueCat`

<table>
	<thead>
		<tr>
			<th>Old type name</th>
			<th>New type name</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>Purchases.Offering</td>
			<td>Offering</td>
		</tr>
		<tr>
			<td>Purchases.ErrorDomain</td>
			<td>See error handling below</td>
		</tr>
		<tr>
			<td>Purchases.ErrorCode.Code</td>
			<td>See error handling below</td>
		</tr>
		<tr>
			<td>Purchases.Package</td>
			<td>Package</td>
		</tr>
		<tr>
			<td>Purchases.PurchaserInfo</td>
			<td><strong>CustomerInfo</strong></td>
		</tr>
		<tr>
			<td>Purchases.EntitlementInfos</td>
			<td>EntitlementInfos</td>
		</tr>
		<tr>
			<td>Purchases.Transaction</td>
			<td>Transaction</td>
		</tr>
		<tr>
			<td>Purchases.EntitlementInfo</td>
			<td>EntitlementInfo</td>
		</tr>
		<tr>
			<td>Purchases.PeriodType</td>
			<td>PeriodType</td>
		</tr>
		<tr>
			<td>Purchases.Store</td>
			<td>Store</td>
		</tr>
		<tr>
			<td>RCPurchaseOwnershipType</td>
			<td>PurchaseOwnershipType</td>
		</tr>
		<tr>
			<td>RCAttributionNetwork</td>
			<td>AttributionNetwork</td>
		</tr>
		<tr>
			<td>RCIntroEligibility</td>
			<td>IntroEligibility</td>
		</tr>
		<tr>
			<td>RCIntroEligibilityStatus</td>
			<td>IntroEligibilityStatus</td>
		</tr>
		<tr>
			<td>Purchases.LogLevel</td>
			<td>LogLevel</td>
		</tr>
		<tr>
			<td>Purchases.Offerings</td>
			<td>Offerings</td>
		</tr>
		<tr>
			<td>Purchases.PackageType</td>
			<td>PackageType</td>
		</tr>
		<tr>
			<td>Package.product</td>
			<td>Package.storeProduct</td>
		</tr>
		<tr>
			<td>Package.product.price: NSDecimalNumber</td>
			<td>Package.storeProduct.price: Decimal</td>
		</tr>
		<tr>
			<td>Package.localizedIntroductoryPriceString: String</td>
			<td>Package.localizedIntroductoryPriceString: String?</td>
		</tr>
		<tr>
			<td>RCDeferredPromotionalPurchaseBlock</td>
			<td>DeferredPromotionalPurchaseBlock</td>
		</tr>
		<tr>
			<td>Purchases.PurchaseCompletedBlock</td>
			<td>PurchaseCompletedBlock</td>
		</tr>
		<tr>
			<td>Purchases.ReceivePurchaserInfoBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>Purchases.ReceiveOfferingsBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>Purchases.ReceiveProductsBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>Purchases.PaymentDiscountBlock</td>
			<td><i>REMOVED</i></td>
		</tr>
				<tr>
			<td>Purchases.RevenueCatBackendErrorCode</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>Purchases.ErrorCode.operationAlreadyInProgressError</td>
			<td>RevenueCat.ErrorCode.operationAlreadyInProgressForProductError</td>
		</tr>
		<tr>
			<td>Purchases.ErrorUtils</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>ReadableErrorCodeKey</td>
			<td><i>REMOVED</i></td>
		</tr>
		<tr>
			<td>RCFinishableKey</td>
			<td><i>REMOVED</i></td>
		</tr>
	</tbody>
</table>

### Swift API changes

<table>
	<thead>
		<tr>
			<th>Old API</th>
			<th>New API</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>invalidatePurchaserInfoCache</td>
			<td>invalidateCustomerInfoCache</td>
		</tr>
		<tr>
			<td>logIn(_ appUserId:, _ completion:)</td>
			<td>logIn(appUserId:completion:)</td>
		</tr>
		<tr>
			<td>createAlias(_ alias:, _ completion:)</td>
			<td>logIn(_ appUserID:, completion:)</td>
		</tr>
		<tr>
			<td>identify(_ appUserID:, _ completion:)</td>
			<td>logIn(_ appUserID:, completion:)</td>
		</tr>
		<tr>
			<td>reset(completion:)</td>
			<td>logOut(completion:)</td>
		</tr>
		<tr>
			<td>purchaserInfo(_ completion:)</td>
			<td>getCustomerInfo(completion:)</td>
		</tr>
		<tr>
			<td>offerings(_ completion:)</td>
			<td>getOfferings(completion:)</td>
		</tr>
		<tr>
			<td>products(_ productIdentifiers:, _ completion:)</td>
			<td>getProducts(identifiers: completion:)</td>
		</tr>
		<tr>
			<td>purchaseProduct(_ product:, _ completion:)</td>
			<td>purchase(product:, completion:)</td>
		</tr>
		<tr>
			<td>purchasePackage(_ package:, _ completion:)</td>
			<td>purchase(package:, completion:)</td>
		</tr>
		<tr>
			<td>restoreTransactions(_ completion:)</td>
			<td>restoreTransactions(completion:)</td>
		</tr>
		<tr>
			<td>syncPurchases(_ completion:)</td>
			<td>syncPurchases(completion:)</td>
		</tr>
		<tr>
			<td>paymentDiscount(for:product:completion:)</td>
			<td>paymentDiscount(forProductDiscount:product:completion:)</td>
		</tr>
		<tr>
			<td>purchaseProduct(_:discount:_)</td>
			<td>purchase(product:discount:completion:)</td>
		</tr>
		<tr>
			<td>purchasePackage(_:discount:_)</td>
			<td>purchase(package:discount:completion:)</td>
		</tr>
		<tr>
			<td colspan="2" style="text-align:center;" ><strong>PurchasesDelegate<strong></td>
		</tr>
		<tr>
			<td>purchases(_ purchases: Purchases, didReceiveUpdated purchaserInfo: PurchaserInfo)</td>
			<td>purchases(_ purchases: Purchases, receivedUpdated customerInfo: CustomerInfo)</td>
		</tr>
	</tbody>
</table>

### Swift Error handling

Prior to the Swift migration, `Purchases` exposed errors as `NSError`s, so one could detect errors like this:
```swift
if error.domain == Purchases.ErrorDomain {
	switch Purchases.ErrorCode(_nsError: error).code {
		case .purchaseInvalidError: break
		default: break
	}
}
```
Starting from Version 4, this becomes much simpler:
```swift
if let error = error as? RevenueCat.ErrorCode {
	switch error {
		case .purchaseInvalidError: break
		default: break
	}
} else {
	// Error is a different type
}
```

### New APIs

- `showManageSuscriptions(completion:)`: Use this method to show the subscription management for the current user. Depending on where they made the purchase and their OS version, this might take them to the `managementURL`, or open the iOS Subscription Management page. 
- `beginRefundRequest(for:)`: Use this method to begin a refund request for a purchase, specifying the product identifier.

## Reporting undocumented issues:

Feel free to file an issue! [New RevenueCat Issue](https://github.com/RevenueCat/purchases-ios/issues/new/).
