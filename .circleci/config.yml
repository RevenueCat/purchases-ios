version: 2.1
jobs:
  runtest:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      
      # Carthage
      - restore_cache:
          keys: 
            - carthage-cache-{{ checksum "Cartfile.resolved" }}
      - run:
          name: Carthage Bootstrap
          command: |
              ./carthage.sh bootstrap --cache-builds
      - save_cache:
          key: carthage-cache-{{ checksum "Cartfile.resolved" }}
          paths:
            - Carthage
      
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}
      - run: bundle install --clean --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      
      - run:
          name: Run tests
          command: fastlane scan
          environment:
            SCAN_SCHEME: All Tests
      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane/test_output/report.html
          destination: test_report.html
  docs-deploy:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - run: bundle install
      - run:
          name: Build docs
          command: fastlane run jazzy
      - run:
          name: Install awscli
          command: sudo python3 -m pip install awscli
      - run:
          name: Deploy to S3
          command: aws s3 sync docs s3://purchases-docs/ios --delete --acl public-read
      - run:
          name: Invalidate CloudFront caches
          command: aws cloudfront create-invalidation --distribution-id EPTW7F3CB566V --paths "/*"
  

  integration-tests-cocoapods:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios/
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      
      # cocoapods
      - run:
          name: Install Pods
          command: |
              cd IntegrationTests/CocoapodsIntegration/
              pod install
      
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}
      - run:
          command: |
              cd IntegrationTests/CocoapodsIntegration/
              bundle install --clean --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      
      - run:
          name: Run tests
          command: |
              cd IntegrationTests/CocoapodsIntegration/
              fastlane scan
      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane/test_output/report.html
          destination: test_report.html
      - run:
          name: Archive
          command: |
              cd IntegrationTests/CocoapodsIntegration/
              fastlane gym
      
  integration-tests-swift-package-manager:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios/
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}
      - run:
          command: |
              cd IntegrationTests/SPMIntegration/
              bundle install --clean --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      
      - run:
          name: Run tests
          command: |
              cd IntegrationTests/SPMIntegration/
              fastlane scan
      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane/test_output/report.html
          destination: test_report.html
      - run:
          name: Archive
          command: |
              cd IntegrationTests/SPMIntegration/
              fastlane gym
  
  integration-tests-carthage:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios/
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      
      # Carthage
      - restore_cache:
          keys: 
            - carthage-cache-{{ checksum "Cartfile.resolved" }}
      - run:
          name: Carthage Update
          command: |
              cd IntegrationTests/CarthageIntegration/
              ./carthage.sh update --cache-builds
      - save_cache:
          key: carthage-cache-{{ checksum "Cartfile.resolved" }}
          paths:
            - Carthage
      
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}
      - run:
          command: |
              cd IntegrationTests/CarthageIntegration/
              bundle install --clean --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      
      - run:
          name: Run tests
          command: |
              cd IntegrationTests/CarthageIntegration/
              fastlane scan
      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane/test_output/report.html
          destination: test_report.html
      - run:
          name: Archive
          command: |
              cd IntegrationTests/CarthageIntegration/
              fastlane gym

  integration-tests-xcode-direct-integration:
    macos:
      xcode: "12.0"
    working_directory: ~/purchases-ios/
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      
      # Bundler
      - restore_cache:
          keys: 
            - gem-cache-{{ checksum "Gemfile.lock" }}
      - run:
          command: |
              cd IntegrationTests/XcodeDirectIntegration/
              bundle install --clean --path vendor/bundle
      - save_cache:
          key: gem-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      
      # - run:
      #     name: Run tests
      #     command: |
      #         cd IntegrationTests/XcodeDirectIntegration/
      # - store_test_results:
      #     path: fastlane/test_output
      # - store_artifacts:
      #     path: fastlane/test_output/report.html
      #     destination: test_report.html
      - run:
          name: Archive
          command: |
              cd IntegrationTests/XcodeDirectIntegration/
              fastlane run setup_circle_ci
              fastlane match appstore --readonly
              fastlane gym --export_method app-store

workflows:
  version: 2
  build-test:
    jobs:
      # - runtest
      # - integration-tests-cocoapods
      # - integration-tests-swift-package-manager
      # - integration-tests-carthage
      - integration-tests-xcode-direct-integration
  docs:
    jobs:
      - docs-deploy:
          filters:
            tags:
              ignore: /^.*-SNAPSHOT/
            branches:
              ignore: /.*/

